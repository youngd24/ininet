#!/usr/local/bin/bash
# INITECH Application Selection System  style dialog launcher
# Compatible with: Solaris 7 (bash 4.1.0, dialog 1.0) and Ubuntu 24 (bash 5.2, dialog 1.3)

set -u

# --- Locate dialog (favor PATH, but try common spots) ---
DIALOG_BIN=""
for d in dialog /usr/local/bin/dialog /usr/bin/dialog; do
  if command -v "$d" >/dev/null 2>&1; then
    DIALOG_BIN="$(command -v "$d")"
    break
  fi
done

if [ -z "${DIALOG_BIN}" ]; then
  echo "ERROR: 'dialog' not found. Please install it and ensure it's in PATH."
  exit 1
fi

# --- App definitions ---
APP1_NAME="Bank Management System"
APP1_CMD="/export/initech/banking/initech_bank_mvp.sh"

APP2_NAME="Finance System"
APP2_CMD="/export/initech/finance/vapid"

APP3_NAME="Check Email"
APP3_CMD="pine"

TITLE="INITECH Application Selection System"
BACKTITLE="INITECH Application Selection Menu"

# --- Simple retro banner for CLI run portions (no printf; Solaris-safe) ---
banner() {
  SAFE_TERM="${TERM:-unknown}"
  case "$SAFE_TERM" in
    -*) SAFE_TERM="unknown" ;;
  esac
  HOSTNAME="$(uname -n 2>/dev/null || echo unknown)"
  NOW="$(date 2>/dev/null || echo "unknown")"

  cat <<EOF

============================================================
                 INITECH APPLICATION LAUNCHER
============================================================
   Terminal: ${SAFE_TERM}   Host: ${HOSTNAME}
   Date: ${NOW}
------------------------------------------------------------

EOF
}

# --- Helper: run a command if present/executable ---
run_app() {
  app_label="$1"
  app_path="$2"

  if ! command -v "$app_path" >/dev/null 2>&1 && [ ! -x "$app_path" ]; then
    "$DIALOG_BIN" --title "$TITLE" --backtitle "$BACKTITLE" \
      --msgbox "$app_label\n\nCommand not found or not executable:\n$app_path" 10 70
    return 0
  fi

  # Clear curses UI before switching to raw program output
  clear
  banner
  echo "Launching: $app_label"
  echo "Command  : $app_path"
  echo
  # Run the app in the current tty; user returns here when it exits
  $app_path
  app_rc=$?

  echo
  echo "------------------------------------------------------------"
  echo "Application exited with status: $app_rc"
  echo "Press Enter to return to the INITECH menu..."
  read _unused
}

# --- Main loop ---
while :; do
  CHOICE=$("$DIALOG_BIN" --clear \
    --title "$TITLE" \
    --backtitle "$BACKTITLE" \
    --menu "Select an application to run:" 17 70 7 \
      1 "$APP1_NAME" \
      2 "$APP2_NAME" \
      3 "$APP3_NAME" \
      Q "Quit" 2>&1 > /dev/tty)

  rc=$?
  case "$rc" in
    0)
      case "$CHOICE" in
        1) run_app "$APP1_NAME" "$APP1_CMD" ;;
        2) run_app "$APP2_NAME" "$APP2_CMD" ;;
        3) run_app "$APP3_NAME" "$APP3_CMD" ;;
        Q) clear; exit 0 ;;
        *) : ;;
      esac
      ;;
    1|255)
      # Cancel or ESC
      clear
      exit 0
      ;;
    *)
      clear
      exit "$rc"
      ;;
  esac
done

