##############################################################################
# Swatchdog RC file: Comprehensive monitoring for Ubuntu 24
##############################################################################

##########################
# 1. Authentication Events
##########################

# Failed SSH root login attempts (3+ in 5 min per IP)
# RULEID:1
watchfor /Failed password for root from ([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)/
    echo=red
    exec "logger swatchdog hit RULEID:1"
    exec "/usr/local/bin/asa_block_ip.expect $1"
    mail addresses=alerts\@inidev.io,subject="RED ALERT: 3+ failed root SSH logins from $1"
    threshold track_by=$1,type=limit,count=3,seconds=300
    throttle 00:05

# Failed SSH user login attempts (3+ in 5 min per IP)
# RULEID:2
watchfor /Failed password for (?!root).* from ([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)/
    echo=yellow
    exec "logger swatchdog hit RULEID:2"
    exec "/usr/local/bin/asa_block_ip.expect $1"
    mail addresses=alerts\@inidev.io,subject="YELLOW ALERT: 3+ failed root SSH logins from $1"
    threshold track_by=$1,type=limit,count=3,seconds=300
    throttle 00:05

# Invalid user login attempts (3+ in 5 min per IP)
# RULEID:3
watchfor /Invalid user .* from ([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)/
    echo=yellow
    exec "logger swatchdog hit RULEID:3"
    mail addresses=alerts\@inidev.io,subject="ALERT: 3+ invalid user SSH logins from $1"
    threshold track_by=$1,type=limit,count=3,seconds=300
    throttle 00:05

# Successful SSH login as root (should be rare)
watchfor /Accepted .* for root from ([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)/
    throttle 00:05

# sudo authentication failures (3+ in 5 min)
watchfor /sudo: .*authentication failure/
    threshold type=limit,count=3,seconds=300
    throttle 00:05

# Locked account login attempts
watchfor /account .* locked/


##########################
# 2. Privilege Escalation & User Management
##########################

# New user added
watchfor /new user: name=/
    throttle 00:05

# User added to sudo group
watchfor /usermod.*: add 'sudo'/
    throttle 00:05

# Password changes
watchfor /passwd.*password updated successfully/
    throttle 00:05


##########################
# 3. System Integrity / Service Failures
##########################

# systemd failures
watchfor /systemd.*(failed|dependency failed|dead)/
    throttle 00:05

# Kernel panics, oops, bugs
watchfor /kernel: (panic|Oops|BUG)/
    throttle 00:05

# AppArmor or SELinux denials
watchfor /audit.*DENIED/
    throttle 00:05


##########################
# 4. File Integrity & Security
##########################

# Changes to passwd or shadow
watchfor /(passwd|shadow) .* changed/
    throttle 00:05


##########################
# 5. Disk, Memory, and Hardware Health
##########################

# Disk full
watchfor /No space left on device/
    throttle 00:05

# Disk I/O errors
watchfor /(EXT4-fs error|Buffer I\/O error)/
    throttle 00:05

# Out-of-memory killer invoked
watchfor /Out of memory|oom-killer/
    throttle 00:05

# Hardware errors
watchfor /ata.*failed/
    throttle 00:05


##########################
# 6. Network & Firewall Events
##########################

# UFW blocks (3+ in 5 min per IP)
watchfor /UFW BLOCK.*SRC=([0-9]+\.[0-9]+\.[0-9]+\.[0-9]+)/
    threshold track_by=$1,type=limit,count=3,seconds=300
    throttle 00:05

# Repeated connection failures (Postfix/Apache)
watchfor /(postfix|apache2).*(connection refused|client denied by server configuration)/
    throttle 00:05


##########################
# 7. Cron and Scheduled Job Failures
##########################

# Cron job failures
watchfor /CRON.*(failed|error)/
    throttle 00:05

# Anacron errors
watchfor /anacron.*(Can not|error)/
    throttle 00:05


##########################
# 8. Reboots & Unexpected Shutdowns
##########################

# Unexpected reboots/shutdowns
watchfor /(Starting Clean shutdown|reboot)/
    throttle 00:05
